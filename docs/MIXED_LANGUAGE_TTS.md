# 混合语言TTS处理系统

## 概述

我们的系统现在支持智能的泰英混合语言文本转语音处理，能够自动检测文本中的语言切换，并使用相应的原生TTS引擎生成高质量的音频。

## 主要功能

### 1. 智能语言检测

- **单词级别检测**：准确识别每个单词的语言
- **上下文感知**：标点符号跟随上下文语言
- **自动分段**：将混合文本分割为语言一致的段落

### 2. 原生TTS支持

- **泰语TTS**：`th-TH-Chirp3-HD-Fenrir` - 高质量泰语语音
- **英语TTS**：`en-US-Chirp3-HD-Achernar` - 高质量英语语音
- **智能切换**：根据文本内容自动选择合适的TTS引擎

### 3. 学习优化

- **英语停顿**：英语单词间自动添加0.3秒停顿
- **语速调整**：英语0.8倍速，泰语正常速度
- **无缝合并**：多段音频无缝连接

## 处理示例

### 示例1：词汇教学

**输入文本**：

```
คำศัพท์แรกคือ coffee - กาแฟ
```

**处理过程**：

1. **语言分段**：
   - `"คำศัพท์แรกคือ "` → 泰语段落
   - `"coffee - "` → 英语段落
   - `"กาแฟ"` → 泰语段落

2. **音频生成**：
   - 泰语TTS：`"คำศัพท์แรกคือ "`
   - 英语TTS：`"<break time="0.3s"/>coffee<break time="0.3s"/>-<break time="0.5s"/>"`
   - 泰语TTS：`"กาแฟ"`

3. **最终效果**：自然的泰语解释 + 清晰的英语发音 + 泰语翻译

### 示例2：情境对话

**输入文本**：

```
เมื่อคุณไปที่ Starbucks คุณสามารถพูดว่า "Can I have a coffee please?" ได้
```

**处理过程**：

1. **智能分段**：
   - `"เมื่อคุณไปที่ "` → 泰语
   - `"Starbucks "` → 英语
   - `"คุณสามารถพูดว่า "` → 泰语
   - `"Can I have a coffee please? "` → 英语
   - `"ได้"` → 泰语

2. **音频效果**：
   - 泰语解释使用自然的泰语发音
   - 品牌名"Starbucks"使用英语发音
   - 英语句子有适当停顿便于学习
   - 整体音频流畅自然

## 技术实现

### 语言检测算法

```typescript
private determineTokenLanguage(token: string, contextLanguage: 'thai' | 'english' = 'thai'): 'thai' | 'english' {
  const trimmedToken = token.trim();

  // 标点符号跟随上下文语言
  if (/^[^\w\u0E00-\u0E7F]+$/.test(trimmedToken)) {
    return contextLanguage;
  }

  const isEnglishToken = /^[a-zA-Z]+$/.test(trimmedToken);
  const hasThaiChars = /[\u0E00-\u0E7F]/.test(token);

  return (isEnglishToken && !hasThaiChars) ? 'english' : 'thai';
}
```

### 音频处理流程

1. **文本分析**：检测混合语言段落
2. **分段处理**：为每个语言段落生成音频
3. **停顿添加**：为英语段落添加学习停顿
4. **音频合并**：使用ffmpeg无缝连接
5. **质量保证**：统一采样率和格式

## 配置参数

### TTS设置

```typescript
// 英语配置
voice: {
  name: 'en-US-Chirp3-HD-Achernar',
  languageCode: 'en-US',
}
audioConfig: {
  speakingRate: 0.8,  // 80%语速便于学习
  sampleRateHertz: 24000,
}

// 泰语配置
voice: {
  name: 'th-TH-Chirp3-HD-Fenrir',
  languageCode: 'th-TH',
}
audioConfig: {
  speakingRate: 1.0,  // 正常语速
  sampleRateHertz: 24000,
}
```

### 停顿设置

```typescript
// 英语停顿配置
.replace(/\s+/g, ' <break time="0.3s"/> ')        // 单词间停顿
.replace(/([.!?])\s*/g, '$1 <break time="0.8s"/> ') // 句子间停顿
.replace(/([,;:])\s*/g, '$1 <break time="0.5s"/> ') // 标点停顿
```

## 使用场景

### 1. 词汇教学

- 泰语解释 + 英语单词 + 泰语翻译
- 清晰的英语发音便于模仿
- 自然的泰语解释降低理解门槛

### 2. 语法讲解

- 泰语语法解释 + 英语例句
- 结构化的学习内容
- 渐进式语言接触

### 3. 情境对话

- 泰语情境描述 + 英语对话
- 真实场景应用
- 文化背景融入

### 4. 练习指导

- 泰语指令 + 英语练习内容
- 清晰的任务说明
- 互动式学习体验

## 性能优化

### 缓存机制

- 相同文本内容复用已生成音频
- 临时文件自动清理
- 错误恢复和重试机制

### 并发处理

- 多段落并行生成音频
- 异步音频合并
- 资源使用优化

## 质量保证

### 音频质量

- 24kHz高质量采样率
- 无损音频合并
- 统一音量和格式

### 发音准确性

- 原生TTS引擎确保发音准确
- 语言特定的语音特征
- 自然的语调和节奏

## 未来扩展

### 多语言支持

- 支持更多语言对组合
- 动态语言检测
- 自定义TTS引擎

### 个性化设置

- 用户自定义语速
- 可调节停顿时长
- 语音风格选择

### 高级功能

- 情感语调调整
- 重音和语调标记
- 实时语音合成

---

这个混合语言TTS系统为泰国学生提供了更自然、更有效的英语学习体验，通过智能的语言处理和高质量的语音合成，显著提升了学习效果和用户体验。
