# Mixed Language TTS Optimization

## Overview

This document describes the optimization made to the `audio_segments.json` generation to support separate Thai and English text parts with different speaking rates for better learning experience.

## Problem Statement

Previously, the audio segments contained mixed Thai and English text in a single `text` field. This made it impossible to:

- Apply different speaking rates to English vs Thai portions
- Provide slower, clearer English pronunciation for language learners
- Maintain natural Thai narration speed

## Solution

Implemented a multi-part audio generation system that:

1. Separates Thai and English text into individual parts
2. Generates separate audio files for each part with appropriate speaking rates
3. Merges the audio files seamlessly using ffmpeg
4. Uses the same high-quality voice (th-TH-Chirp3-HD-Achird) for all parts

## Changes Made

### 1. Data Structure Updates

#### `src/video-transform/dto/audio-segments.dto.ts`

Added new interfaces:

```typescript
export interface TextPart {
  text: string;
  language: 'th' | 'en';
  speakingRate?: number; // Default: th=1.0, en=0.8
}

export interface AudioSegment {
  id: string;
  text: string; // Full text for display and backward compatibility
  textParts?: TextPart[]; // Separated Thai and English parts for TTS
  // ... other fields
}
```

#### `src/video-transform/types/lesson-data.types.ts`

Synchronized the same interface updates.

### 2. LLM Prompt Update

#### `src/video-transform/services/audio-segments.service.ts`

Updated the LLM prompt to generate both `text` and `textParts` fields:

**Example Output:**

```json
{
  "id": "vocab_restaurant",
  "text": "คำศัพท์: restaurant — ร้านอาหาร ใช้เมื่อพูดถึงสถานที่กินข้าว เช่น Let's go to a Japanese restaurant near Siam",
  "textParts": [
    { "text": "คำศัพท์: ", "language": "th" },
    { "text": "restaurant", "language": "en", "speakingRate": 0.8 },
    { "text": " — ร้านอาหาร ใช้เมื่อพูดถึงสถานที่กินข้าว เช่น ", "language": "th" },
    { "text": "Let's go to a Japanese restaurant near Siam", "language": "en", "speakingRate": 0.8 }
  ]
}
```

### 3. TTS Service Enhancement

#### `src/video-transform/services/tts-audio-segments.service.ts`

**New Method: `generateTtsAudioWithParts()`**

- Processes `textParts` array
- Generates individual audio files for each part
- Applies appropriate speaking rates (th=1.0, en=0.8)
- Merges audio files seamlessly

**New Method: `mergeAudioFiles()`**

- Uses ffmpeg concat demuxer to merge audio files
- No re-encoding needed (fast operation)
- Maintains consistent audio quality

**Updated: `generateTtsAudioSegmentsForEpisode()`**

- Checks for `textParts` in segments
- Falls back to `text` field for backward compatibility
- Logs detailed information about multi-part generation

## Technical Details

### Audio Settings

- **Voice**: `th-TH-Chirp3-HD-Achird` (for both Thai and English)
- **Format**: WAV LINEAR16
- **Sample Rate**: 24000 Hz
- **Thai Speaking Rate**: 1.0 (normal)
- **English Speaking Rate**: 0.8 (25% slower for better comprehension)

### Audio Merging Process

1. Generate temporary audio files: `{segment_id}_part_0.wav`, `{segment_id}_part_1.wav`, etc.
2. Create ffmpeg concat list file
3. Merge using: `ffmpeg -f concat -safe 0 -i concat.txt -c copy output.wav`
4. Clean up temporary files
5. Calculate total duration using ffprobe

## Benefits

1. **Better Learning Experience**: Slower English pronunciation helps learners understand and repeat phrases
2. **Natural Thai Narration**: Thai explanations remain at natural speaking speed
3. **Seamless Audio**: Same voice for all parts ensures smooth, natural transitions
4. **Backward Compatibility**: Existing audio_segments.json files still work
5. **High Quality**: No quality loss from re-encoding

## Usage

### Generating New Audio Segments

Simply regenerate the audio segments for a lesson:

```bash
# Delete existing audio segments
rm videos/henIVlCPVIY/lesson_1/audio_segments.json
rm videos/henIVlCPVIY/lesson_1/lesson_segments/*.wav
rm videos/henIVlCPVIY/lesson_1/lesson_segments/timing-metadata.json

# Regenerate (through API or service)
# The new textParts structure will be automatically generated by LLM
```

### Testing

Run the test script to verify mixed-language TTS:

```bash
npm run build
node dist/scripts/test-mixed-language-tts.js
```

This will generate test audio files in `audios/test-mixed-language/` with various Thai-English combinations.

## Example Segment Structure

```json
{
  "id": "practice_concierge_reservation",
  "text": "ฝึกพูด: สถานการณ์ที่ล็อบบี้โรงแรม คุณอยากได้ร้านมังสวิรัติใกล้ CentralWorld และต้องการจองโต๊ะ ลองพูดตามทีละประโยค I'd like to make a reservation for two at 7 pm. Could you recommend a vegetarian restaurant nearby?",
  "textParts": [
    {
      "text": "ฝึกพูด: สถานการณ์ที่ล็อบบี้โรงแรม คุณอยากได้ร้านมังสวิรัติใกล้ CentralWorld และต้องการจองโต๊ะ ลองพูดตามทีละประโยค ",
      "language": "th"
    },
    {
      "text": "I'd like to make a reservation for two at 7 pm.",
      "language": "en",
      "speakingRate": 0.8
    },
    {
      "text": " ",
      "language": "th"
    },
    {
      "text": "Could you recommend a vegetarian restaurant nearby?",
      "language": "en",
      "speakingRate": 0.8
    }
  ],
  "description": "แบบฝึกพูดกับคอนเซียร์จ: ขอจองโต๊ะ ขอคำแนะนำ และเรียกแท็กซี่",
  "screenElement": "practice_card"
}
```

## Future Enhancements

1. **Configurable Speaking Rates**: Allow different rates for different segment types (vocabulary, practice, etc.)
2. **Pause Duration**: Add support for pauses between parts for better comprehension
3. **Emphasis**: Support emphasis on important words or phrases
4. **Multiple Languages**: Extend support for other language pairs

## Troubleshooting

### Audio segments not merging

- Ensure ffmpeg is installed and accessible
- Check that all part files have the same audio format (24kHz, LINEAR16)

### Slow generation

- Multi-part generation takes longer due to multiple TTS API calls
- Consider caching or reusing previously generated segments

### Quality issues

- Verify Google Cloud TTS credentials are properly configured
- Ensure network connection is stable for TTS API calls

## Related Files

- `src/video-transform/dto/audio-segments.dto.ts` - Data structures
- `src/video-transform/types/lesson-data.types.ts` - Type definitions
- `src/video-transform/services/audio-segments.service.ts` - LLM-based generation
- `src/video-transform/services/tts-audio-segments.service.ts` - TTS synthesis and merging
- `scripts/test-mixed-language-tts.ts` - Test script
