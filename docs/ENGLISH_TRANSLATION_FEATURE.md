# English Translation Feature for Thai Text

## Overview

This feature adds English reference translations to all Thai text displayed in videos. The translations are shown below the Thai text in a smaller font for learner reference and **do not affect audio playback**.

## Visual Display

- **Thai text**: Displayed in normal size (34-42px depending on component)
- **English translation**: Displayed below Thai text in smaller italic font (24px)
- **Positioning**: Thai text on top, English below
- **Styling**: English text is lighter and italic to distinguish it as a reference

## Implementation

### 1. Data Structure

All Thai `textParts` now include an `englishTranslation` field:

```typescript
interface TextPart {
  text: string;
  language: "th" | "en";
  speakingRate?: number;
  englishTranslation?: string; // Only for Thai text parts
}
```

Example:

```json
{
  "text": "สวัสดีค่ะ ยินดีต้อนรับ",
  "language": "th",
  "englishTranslation": "Hello everyone, welcome"
}
```

### 2. Data Flow

1. **Audio Segments Service** (`audio-segments.service.ts`)

   - LLM generates English translations for all Thai text
   - Adds `englishTranslation` field to Thai textParts
   - Saves to `audio_segments.json`

2. **TTS Service** (`tts-audio-segments.service.ts`)

   - Preserves `englishTranslation` in timing metadata
   - Does NOT generate audio for translations (display only)
   - Passes translation data through to timing files

3. **Synchronized Lesson Service** (`synchronized-lesson.service.ts`)

   - Copies `englishTranslation` to `final_synchronized_lesson.json`
   - Maintains translation data for video rendering

4. **Remotion Components**

   - `ObjectiveCard.tsx`
   - `GrammarCard.tsx`
   - `PracticeCard.tsx`
   - All display Thai text with English below

5. **Interactive Viewer**
   - Uses Remotion components automatically
   - No additional changes needed

### 3. Modified Files

**Backend:**

- `backend/src/video-transform/dto/audio-segments.dto.ts`
- `backend/src/video-transform/types/lesson-data.types.ts`
- `backend/src/video-transform/services/audio-segments.service.ts`
- `backend/src/video-transform/services/tts-audio-segments.service.ts`
- `backend/src/video-transform/services/synchronized-lesson.service.ts`

**Frontend (Remotion):**

- `remotion/src/components/ObjectiveCard.tsx`
- `remotion/src/components/GrammarCard.tsx`
- `remotion/src/components/PracticeCard.tsx`

**Testing:**

- `backend/scripts/test-english-translation.ts`
- `backend/scripts/README.md`

## Usage

### Generating New Lessons

When generating new lessons, English translations are automatically included:

```bash
cd backend
npm run start:dev

# Then use API endpoint to generate lesson
POST /api/video-transform/generate
{
  "youtubeUrl": "...",
  "videoId": "..."
}
```

### Testing Translation Feature

```bash
cd backend
npm run build

# Test existing lesson
node dist/scripts/test-english-translation.js henIVlCPVIY 1
```

Expected output:

```
✅ Generated 15 audio segments
📊 Statistics:
   Total text parts: 45
   Thai text parts: 30
   Translated parts: 30
   Missing translations: 0

✅ SUCCESS: All Thai text parts have English translations!
```

### Regenerating Translations for Existing Lessons

If you have existing lessons without translations, simply delete the `audio_segments.json` file and regenerate:

```bash
# Delete old audio segments
rm backend/videos/henIVlCPVIY/lesson_1/audio_segments.json

# Regenerate (backend must be running)
curl -X POST http://localhost:3000/api/video-transform/generate-audio-segments \
  -H "Content-Type: application/json" \
  -d '{"videoId": "henIVlCPVIY", "lessonNumber": 1}'
```

## Example Display

In the video, Thai text with English translation appears as:

```
┌────────────────────────────────────────┐
│                                        │
│  สวัสดีค่ะ ยินดีต้อนรับ               │  ← Thai (34px)
│  Hello everyone, welcome               │  ← English (24px, italic, lighter)
│                                        │
└────────────────────────────────────────┘
```

## Translation Quality

English translations are generated by the LLM with these characteristics:

- **Accurate**: Faithful to the Thai meaning
- **Natural**: Reads naturally in English
- **Concise**: Matches the brevity of Thai text
- **Context-aware**: Considers lesson context

The LLM prompt specifically instructs:

```
For ALL Thai text parts (language: "th"), you MUST provide an
"englishTranslation" field with an English translation. This
translation is for visual reference only and will NOT be spoken.
```

## Benefits

1. **Learning Aid**: Helps students understand Thai explanations
2. **Verification**: Allows students to verify their understanding
3. **No Audio Impact**: Doesn't change lesson timing or audio
4. **Automatic**: Requires no manual translation work
5. **Consistent**: All Thai text gets translated uniformly

## Technical Notes

### Why Not in Audio?

The English translations are **display-only** for these reasons:

1. **Preserve Thai Learning**: Students need Thai immersion
2. **Timing Consistency**: Keeps original lesson pacing
3. **Audio Quality**: Avoids switching between languages mid-sentence
4. **User Control**: Students can read at their own pace

### Font Sizing

Font sizes are carefully chosen:

- **Thai text**: Large enough to be primary focus
- **English text**: Smaller to indicate secondary/reference nature
- **Contrast**: Clear visual hierarchy between languages

### Text Merging

The TTS service may merge short Thai text parts (< 3 characters) for smooth audio. When merging, English translations are also merged:

```typescript
if (previous.englishTranslation && current.englishTranslation) {
  previous.englishTranslation += current.englishTranslation;
}
```

## Future Enhancements

Possible future improvements:

1. **Toggle Display**: Option to hide/show English translations
2. **Translation Quality Scores**: Rate translation accuracy
3. **Manual Override**: Allow manual translation corrections
4. **Multiple Languages**: Support more reference languages
5. **Hover/Click**: Show translation only on interaction

## Troubleshooting

### Missing Translations

If translations are missing:

1. Check LLM is configured properly
2. Verify LLM API key is valid
3. Check LLM response format
4. Re-run audio segments generation

### Incorrect Translations

If translations are wrong:

1. Improve LLM prompt clarity
2. Use a more capable LLM model
3. Add context-specific instructions
4. Manually edit `audio_segments.json` (temporary fix)

### Display Issues

If translations don't appear in video:

1. Verify `englishTranslation` in `audio_segments.json`
2. Check `final_synchronized_lesson.json` has translations
3. Ensure Remotion components are updated
4. Clear Remotion cache and regenerate

## Related Documentation

- [Mixed Language TTS](MIXED_LANGUAGE_TTS.md) - Thai + English audio
- [Video Generation](VIDEO_GENERATION_SUMMARY.md) - Overall video pipeline
- [Remotion Usage](REMOTION_USAGE.md) - Video composition
- [Backend Services](../backend/src/video-transform/README.md) - Service architecture
